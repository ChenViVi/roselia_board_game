<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶é­”ä¹‹è·¯</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
            background: #222;
        }

        #game-container {
            display: flex;
            height: 100vh;
        }

        #canvas-container {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #333;
        }

        canvas {
            display: block;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            cursor: grab;
        }

        canvas:active {
            cursor: grabbing;
        }

        /* ä¾§è¾¹æ æ ·å¼è°ƒæ•´ */
        #sidebar {
            width: 320px;
            background: #f9f9f9;
            padding: 15px;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        h2 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 20px;
        }

        .char-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .char-btn {
            border: 2px solid #ccc;
            border-radius: 50%;
            cursor: pointer;
            overflow: hidden;
            width: 60px;
            height: 60px;
            transition: 0.2s;
        }

        .char-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .char-btn.selected {
            border-color: #e91e63;
            transform: scale(1.1);
            box-shadow: 0 0 10px #e91e63;
        }

        .char-btn.taken {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        #status-area {
            flex: 1;
            overflow-y: auto;
        }

        /* è®©ä¸­é—´å†…å®¹å¯æ»šåŠ¨ */

        .btn {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-primary {
            background: #2196F3;
        }

        .btn-success {
            background: #4CAF50;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #dice-result {
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            color: #e91e63;
            min-height: 30px;
        }

        #turn-indicator {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background: #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .my-turn {
            background: #d1c4e9 !important;
            border: 2px solid #673ab7;
        }

        /* --- æ–°å¢ï¼šç§¯åˆ†æ¦œæ ·å¼ --- */
        #score-container {
            margin-top: 20px;
            border-top: 2px solid #eee;
            padding-top: 10px;
        }

        .score-item {
            display: flex;
            align-items: center;
            background: #fff;
            border-bottom: 1px solid #eee;
            padding: 8px 5px;
        }

        .score-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #ccc;
        }

        .score-info {
            flex: 1;
            font-size: 14px;
        }

        .score-val {
            font-weight: bold;
            color: #E65100;
            font-size: 16px;
        }

        .score-ctrl {
            margin-left: 5px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 12px;
            background: #607D8B;
            width: auto;
            margin-top: 0;
        }

        /* --- æ–°å¢ï¼šå¹¿å‘Šé“¾æ¥åŒºåŸŸæ ·å¼ --- */
        #ad-area {
            margin-top: auto;
            padding-top: 15px;
            border-top: 2px solid #ddd;
            text-align: center;
        }

        .ad-link {
            display: block;
            margin-bottom: 8px;
            padding: 10px;
            background: #ffeb3b;
            /* é†’ç›®çš„é»„è‰²èƒŒæ™¯ */
            color: #d81b60;
            text-decoration: none;
            font-weight: bold;
            border-radius: 8px;
            border: 2px dashed #f57f17;
            transition: 0.2s;
        }

        .ad-link:hover {
            background: #fff176;
            transform: translateY(-2px);
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div id="canvas-container">
            <canvas id="gameCanvas"></canvas>
        </div>
        <div id="sidebar">
            <h2>æ¶é­”ä¹‹è·¯</h2>

            <div id="status-area">
                <!-- é€‰äººç•Œé¢ -->
                <div id="lobby-ui">
                    <p>è¯·é€‰æ‹©è§’è‰²:</p>
                    <div class="char-select" id="char-list"></div>
                    <button id="start-btn" class="btn btn-primary" disabled>å¼€å§‹æ¸¸æˆ</button>
                </div>

                <!-- æ¸¸æˆæ“ä½œç•Œé¢ -->
                <div id="game-ui" style="display: none;">
                    <div id="turn-indicator">ç­‰å¾…å¼€å§‹...</div>

                    <div id="controls">
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-primary" onclick="rollDice(1)">ğŸ² 1ä¸ª</button>
                            <button class="btn btn-primary" onclick="rollDice(2)">ğŸ²ğŸ² 2ä¸ª</button>
                        </div>
                    </div>

                    <div id="dice-result"></div>
                    <button id="end-turn-btn" class="btn btn-success" onclick="endTurn()" disabled>ç»“æŸå›åˆ</button>
                </div>

                <!-- --- æ–°å¢ï¼šç§¯åˆ†æ¦œåŒºåŸŸ --- -->
                <div id="score-container">
                    <h3 style="font-size: 16px; margin: 5px 0;">ğŸ“Š è§’è‰²ä¸å¯å´©ç‚¹æ•°æ’è¡Œæ¦œ</h3>
                    <div id="score-list">
                        <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- --- æ–°å¢ï¼šå¹¿å‘Šé“¾æ¥åŒºåŸŸ --- -->
            <div id="ad-area">
                <a href="https://docs.qq.com/markdown/DTENqRVpxR0tUeFNE" target="_blank" class="ad-link">
                    è§„åˆ™ä¹¦ï¼ˆå›½å†…ä¹Ÿå¯è®¿é—®ï¼‰
                </a>
                <a href="https://github.com/ChenViVi/roselia_board_game/" target="_blank" class="ad-link">
                    Githubä»“åº“
                </a>
            </div>

        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const mapImg = new Image(); mapImg.src = 'map.png';
        const charImgs = {};
        for (let i = 1; i <= 5; i++) {
            charImgs[i] = new Image(); charImgs[i].src = `char${i}.png`;
        }

        let myId = null;
        let myCharId = null;
        let players = {};
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let gameActive = false;
        let currentTurnId = null;

        mapImg.onload = () => {
            canvas.width = mapImg.width;
            canvas.height = mapImg.height;
            draw();
        };

        socket.on('connect', () => { myId = socket.id; });

        socket.on('init', (data) => {
            players = data.players;
            updateLobby(data.takenChars);
            updateScoreBoard(); // åˆå§‹åŒ–ç§¯åˆ†æ¦œ
            if (data.gameStarted) switchToGameUI();
            draw();
        });

        socket.on('updatePlayers', (serverPlayers) => {
            players = serverPlayers;

            const count = Object.keys(players).length;
            const startBtn = document.getElementById('start-btn');
            startBtn.disabled = count < 2;
            startBtn.innerText = count >= 2 ? `å¼€å§‹æ¸¸æˆ (${count}äºº)` : `ç­‰å¾…ç©å®¶ (${count}/5)`;

            updateScoreBoard(); // åˆ·æ–°ç§¯åˆ†æ¦œ
            draw();
        });

        socket.on('takenChars', (list) => { updateLobby(list); });

        socket.on('gameStarted', (data) => {
            switchToGameUI();
            updateTurn(data.currentTurn);
        });

        socket.on('diceRolled', (data) => {
            const resultText = document.getElementById('dice-result');
            resultText.innerText = `ç‚¹æ•°: ${data.details.join('+')} = ${data.roll}`;
            if (data.player === myId) {
                document.getElementById('end-turn-btn').disabled = false;
                document.querySelectorAll('#controls button').forEach(b => b.disabled = true);
            }
        });

        socket.on('turnChanged', (data) => { updateTurn(data.currentTurn); });

        socket.on('playerMoved', (data) => {
            if (players[data.id]) {
                players[data.id].x = data.x;
                players[data.id].y = data.y;
                draw();
            }
        });

        socket.on('gameReset', () => { alert('ç©å®¶é€€å‡ºï¼Œæ¸¸æˆé‡ç½®'); location.reload(); });

        // --- é€»è¾‘å‡½æ•° ---

        function selectChar(id) {
            if (myCharId) return;
            socket.emit('selectCharacter', id);
            myCharId = id;
            document.querySelectorAll('.char-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`btn-char-${id}`).classList.add('selected');
        }

        function updateLobby(takenList) {
            const container = document.getElementById('char-list');
            container.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('div');
                btn.className = `char-btn ${takenList.includes(i) && i !== myCharId ? 'taken' : ''}`;
                btn.id = `btn-char-${i}`;
                btn.innerHTML = `<img src="char${i}.png">`;
                if (!takenList.includes(i) || i === myCharId) {
                    btn.onclick = () => selectChar(i);
                }
                if (i === myCharId) btn.classList.add('selected');
                container.appendChild(btn);
            }
        }

        // --- æ–°å¢ï¼šæ›´æ–°ç§¯åˆ†æ¦œé€»è¾‘ ---
        function updateScoreBoard() {
            const list = document.getElementById('score-list');
            list.innerHTML = '';

            // å°†ç©å®¶åˆ—è¡¨è½¬ä¸ºæ•°ç»„å¹¶æŒ‰IDæ’åºï¼ˆä¿è¯åˆ—è¡¨é¡ºåºä¸ä¹±è·³ï¼‰
            const playerArr = Object.values(players).sort((a, b) => a.id.localeCompare(b.id));

            playerArr.forEach(p => {
                const item = document.createElement('div');
                item.className = 'score-item';

                // å¦‚æœæ˜¯è‡ªå·±ï¼Œåå­—åŠ ä¸ª (æˆ‘)
                const isMe = (p.id === myId);
                const nameSuffix = isMe ? ' (æˆ‘)' : '';

                // åªæœ‰è‡ªå·±æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                let ctrlHtml = '';
                if (isMe) {
                    ctrlHtml = `<button class="btn btn-xs score-ctrl" onclick="modifyScore()">å˜åŠ¨</button>`;
                }

                item.innerHTML = `
                <img src="char${p.charId}.png">
                <div class="score-info">
                    <div>ç©å®¶${p.charId}${nameSuffix}</div>
                    <div class="score-val">${p.score || 0} Pt</div>
                </div>
                ${ctrlHtml}
            `;
                list.appendChild(item);
            });
        }

        // --- æ–°å¢ï¼šä¿®æ”¹åˆ†æ•°äº‹ä»¶ ---
        window.modifyScore = () => {
            const input = prompt("è¯·è¾“å…¥åˆ†æ•°å˜åŠ¨å€¼ (ä¾‹å¦‚: 200 æˆ– -500):");
            if (input) {
                const amount = parseInt(input);
                if (!isNaN(amount)) {
                    socket.emit('changeScore', amount);
                } else {
                    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼");
                }
            }
        };

        document.getElementById('start-btn').onclick = () => { socket.emit('startGame'); };

        function switchToGameUI() {
            gameActive = true;
            document.getElementById('lobby-ui').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
        }

        function updateTurn(turnId) {
            currentTurnId = turnId;
            const isMyTurn = (myId === currentTurnId);
            const indicator = document.getElementById('turn-indicator');
            const diceRes = document.getElementById('dice-result');
            const endBtn = document.getElementById('end-turn-btn');

            diceRes.innerText = '';
            endBtn.disabled = true;

            const buttons = document.querySelectorAll('#controls button');
            buttons.forEach(b => b.disabled = !isMyTurn);

            if (isMyTurn) {
                indicator.innerText = "ğŸ‘‰ è½®åˆ°ä½ äº†ï¼";
                indicator.classList.add('my-turn');
            } else {
                indicator.innerText = "â³ ç­‰å¾…ä»–äºº...";
                indicator.classList.remove('my-turn');
            }
            draw(); // é‡ç»˜ä»¥æ›´æ–°é«˜äº®åœˆ
        }

        window.rollDice = (count) => { socket.emit('rollDice', count); };
        window.endTurn = () => { socket.emit('endTurn'); };

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (mapImg.complete) ctx.drawImage(mapImg, 0, 0);

            Object.values(players).forEach(p => {
                const img = charImgs[p.charId];
                if (img && img.complete) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(p.x + 40, p.y + 40, 45, 0, Math.PI * 2);
                    ctx.fillStyle = (p.id === myId) ? 'rgba(0, 255, 0, 0.5)' : 'rgba(255, 255, 255, 0.5)';
                    ctx.fill();
                    if (p.id === currentTurnId) {
                        ctx.strokeStyle = '#e91e63';
                        ctx.lineWidth = 5;
                        ctx.stroke();
                    }
                    ctx.drawImage(img, p.x, p.y, 80, 80);

                    // åœ¨å¤´åƒä¸Šæ–¹ç»˜åˆ¶ç®€å•åˆ†æ•°æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
                    ctx.fillStyle = "white";
                    ctx.font = "bold 20px Arial";
                    ctx.strokeStyle = "black";
                    ctx.lineWidth = 3;
                    ctx.strokeText(`${p.score || 0}`, p.x + 20, p.y - 10);
                    ctx.fillText(`${p.score || 0}`, p.x + 20, p.y - 10);

                    ctx.restore();
                }
            });
        }

        canvas.onmousedown = (e) => {
            if (!myCharId || !players[myId]) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            const p = players[myId];
            if (mouseX >= p.x && mouseX <= p.x + 80 && mouseY >= p.y && mouseY <= p.y + 80) {
                isDragging = true;
                dragOffset.x = mouseX - p.x;
                dragOffset.y = mouseY - p.y;
            }
        };

        canvas.onmousemove = (e) => {
            if (!isDragging) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;
            const newX = mouseX - dragOffset.x;
            const newY = mouseY - dragOffset.y;

            players[myId].x = newX;
            players[myId].y = newY;
            draw();
            socket.emit('movePlayer', { x: newX, y: newY });
        };

        canvas.onmouseup = () => { isDragging = false; };

        function loop() { requestAnimationFrame(loop); }
        loop();
    </script>
</body>

</html>